<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Helm Grid Editor (1.2)</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
    }
    #palette {
      width: 150px;
      background: #111;
      color: white;
      padding: 10px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: center;
    }
    .helm-thumb {
      width: 100px;
      cursor: grab;
    }
    #grid {
      flex: 1;
      display: grid;
      grid-template-columns: repeat(10, 141px);
      grid-template-rows: repeat(12, 143px);
      gap: 1px;
      background: #222;
      padding: 10px;
    }
    .grid-cell {
      width: 141px;
      height: 143px;
      background: #444;
      position: relative;
    }
    .helm {
      position: absolute;
      width: 141px;
      height: 143px;
      pointer-events: auto;
      cursor: move;
    }
    #exportJSON {
      position: absolute;
      top: 10px;
      right: 10px;
    }
    #output {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 200px;
      background: #000;
      color: #0f0;
      overflow: auto;
      font-size: 12px;
      padding: 10px;
    }
  </style>
</head>
<body>

<div id="palette">
  <h3>Palette</h3>
  <input type="file" id="uploadInput" multiple>
</div>

<div id="grid"></div>
<button id="exportJSON">Export JSON</button>
<pre id="output"></pre>

<script>
const grid = document.getElementById("grid");
const palette = document.getElementById("palette");
const uploadInput = document.getElementById("uploadInput");
const exportBtn = document.getElementById("exportJSON");
const output = document.getElementById("output");

let placedHelms = [];
let movingHelm = null;

for (let row = 0; row < 12; row++) {
  for (let col = 0; col < 10; col++) {
    const cell = document.createElement("div");
    cell.className = "grid-cell";
    cell.dataset.row = row + 1;
    cell.dataset.col = col + 1;
    grid.appendChild(cell);
  }
}

uploadInput.addEventListener("change", e => {
  const files = e.target.files;
  [...files].forEach(file => {
    const reader = new FileReader();
    reader.onload = () => {
      const thumbImg = document.createElement("img");
      thumbImg.src = reader.result;
      thumbImg.className = "helm-thumb";
      thumbImg.draggable = true;
      thumbImg.dataset.name = file.name.replace(/ - thumb\.png$/, "");
      thumbImg.dataset.image = file.name.replace(/ - thumb\.png$/, "") + ".png";
      thumbImg.dataset.thumb = file.name;

      thumbImg.addEventListener("dragstart", e => {
        e.dataTransfer.setData("text/plain", JSON.stringify({
          name: thumbImg.dataset.name,
          image: thumbImg.dataset.image,
          thumb: thumbImg.dataset.thumb
        }));
      });

      palette.appendChild(thumbImg);
    };
    reader.readAsDataURL(file);
  });
});

grid.addEventListener('dragstart', e => {
  if (e.target.classList.contains('helm')) {
    movingHelm = e.target;
    e.dataTransfer.setData("text/plain", JSON.stringify({
      name: movingHelm.dataset.name,
      image: movingHelm.dataset.image,
      thumb: movingHelm.dataset.thumb
    }));
  }
});

grid.addEventListener('dragover', e => {
  e.preventDefault();
});

grid.addEventListener('drop', e => {
  e.preventDefault();
  const cell = e.target.closest('.grid-cell');
  if (!cell) return;

  const data = JSON.parse(e.dataTransfer.getData("text/plain"));

  // Prevent duplicate placement of same helm image
  const existing = [...grid.querySelectorAll('.helm')].find(h => h.dataset.name === data.name);
  if (existing && !movingHelm) {
    alert("This helm is already placed on the grid.");
    return;
  }

  const col = parseInt(cell.dataset.col);
  const row = parseInt(cell.dataset.row);

  if (movingHelm) grid.removeChild(movingHelm);

  if (movingHelm) {
    const prevCol = parseInt(movingHelm.dataset.col);
    const prevRow = parseInt(movingHelm.dataset.row);
    const index = placedHelms.findIndex(h => h.col === prevCol && h.row === prevRow && h.name === data.name);
    if (index !== -1) placedHelms.splice(index, 1);
  }

  const img = document.createElement("img");
  img.src = `images/${data.thumb}`;
  img.className = "helm";
  img.dataset.name = data.name;
  img.dataset.image = data.image;
  img.dataset.thumb = data.thumb;
  img.dataset.col = col;
  img.dataset.row = row;
  img.style.left = `${(col - 1) * 141}px`;
  img.style.top = `${(row - 1) * 143}px`;

  img.draggable = true;
  img.addEventListener('dragstart', e => {
    movingHelm = img;
    e.dataTransfer.setData("text/plain", JSON.stringify({
      name: img.dataset.name,
      image: img.dataset.image,
      thumb: img.dataset.thumb
    }));
  });

  img.addEventListener('click', () => {
    if (confirm("Delete this helm?")) {
      grid.removeChild(img);
      placedHelms = placedHelms.filter(h => !(h.col == col && h.row == row));
    }
  });

  grid.appendChild(img);
  placedHelms.push({ name: data.name, thumb: data.thumb, image: data.image, col, row });
  movingHelm = null;
});

exportBtn.addEventListener("click", () => {
  const json = JSON.stringify(placedHelms, null, 2);
  output.textContent = json;
});
</script>

</body>
</html>
