<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Helm Grid Editor (1.4)</title>
  <style>
    body {
      background: #1a1a1a;
      color: white;
      font-family: sans-serif;
      margin: 0;
      padding: 1rem;
    }
    h1 {
      margin-bottom: 1rem;
    }
    .editor-container {
      display: flex;
      gap: 2rem;
    }
    .palette {
      width: 220px;
      position: sticky;
      top: 1rem;
      align-self: flex-start;
    }
    .palette img {
      width: 100%;
      margin-bottom: 1rem;
      cursor: grab;
      border: 2px solid #333;
    }
    .grid {
      position: relative;
      width: calc(201px * 10);
      height: calc(204px * 10);
      background-color: #2a2a2a;
      border: 2px solid #444;
    }
    .grid-cell {
      position: absolute;
      background-color: #1f1f1f;
      border: 1px solid #555;
      width: 201px;
      height: 204px;
      box-sizing: border-box;
    }
    .helm {
      position: absolute;
      width: 201px;
      height: 204px;
      object-fit: contain;
      border: 2px solid #333;
      cursor: grab;
      box-sizing: border-box;
    }
    button, input[type="file"] {
      padding: 0.5rem 1rem;
      margin-top: 1rem;
      background: #444;
      border: none;
      color: white;
      cursor: pointer;
      display: inline-block;
      margin-right: 1rem;
    }
    #exportArea {
      background: #111;
      color: #0f0;
      padding: 0.5rem;
      margin-top: 1rem;
      white-space: pre-wrap;
      font-family: monospace;
      max-height: 300px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <h1>Helm Grid Editor (1.4)</h1>
  <div class="editor-container">
    <div class="palette">
      <input type="file" id="uploadThumb" accept="image/*" />
      <img src="images/Darth Maul Mask - thumb.png" draggable="true" title="Darth Maul Mask" data-name="Darth Maul Mask" data-image="Darth Maul Mask.png" data-thumb-name="Darth Maul Mask - thumb.png" />
    </div>
    <div class="grid" id="helmGrid"></div>
  </div>
  <button onclick="exportJSON()">Export JSON</button>
  <button onclick="copyJSON()">Copy to Clipboard</button>
  <pre id="exportArea"></pre>

  <script>
    const grid = document.getElementById('helmGrid');
    const palette = document.querySelector('.palette');
    const placedHelms = [];
    let movingHelm = null;

    for (let row = 0; row < 12; row++) {
      for (let col = 0; col < 10; col++) {
        const cell = document.createElement('div');
        cell.className = 'grid-cell';
        cell.style.left = (col * 201) + 'px';
        cell.style.top = (row * 204) + 'px';
        grid.appendChild(cell);
      }
    }

    palette.addEventListener('dragstart', e => {
      if (e.target.tagName === 'IMG') {
        e.dataTransfer.setData("text/plain", JSON.stringify({
          name: e.target.dataset.name,
          thumb: e.target.src,
          image: e.target.dataset.image,
          thumbName: e.target.dataset.thumbName,
          fromPalette: true
        }));
      }
    });

    grid.addEventListener('dragstart', e => {
      if (e.target.classList.contains('helm')) {
        movingHelm = e.target;
        e.dataTransfer.setData("text/plain", JSON.stringify({
          name: movingHelm.dataset.name,
          thumb: movingHelm.src,
          image: movingHelm.dataset.image,
          thumbName: movingHelm.dataset.thumbName,
          fromPalette: false
        }));
      }
    });

    grid.addEventListener('dragover', e => e.preventDefault());

    grid.addEventListener('drop', e => {
      e.preventDefault();
      const data = JSON.parse(e.dataTransfer.getData("text/plain"));
      const rect = grid.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      const col = Math.floor(x / 202) + 1;
      const row = Math.floor(y / 205) + 1;

      if (movingHelm) grid.removeChild(movingHelm);

      const img = document.createElement('img');
      img.src = data.thumb;
      img.className = 'helm';
      img.title = data.name;
      img.dataset.name = data.name;
      img.dataset.image = data.image;
      img.dataset.col = col;
      img.dataset.row = row;
      img.dataset.thumbName = data.thumbName;
      img.draggable = true;
      img.style.left = ((col - 1) * 202) + 'px';
      img.style.top = ((row - 1) * 205) + 'px';

      img.onclick = () => {
        if (confirm("Delete this helm?")) {
          grid.removeChild(img);
          const index = placedHelms.findIndex(h => h.col == col && h.row == row && h.name === data.name);
          if (index !== -1) placedHelms.splice(index, 1);
        }
      };

      grid.appendChild(img);
      const thumbFilename = img.dataset.thumbName || data.thumb.split('/').pop();
      placedHelms.push({ name: data.name, thumb: thumbFilename, image: data.image, col, row });

      if (data.fromPalette) {
        const images = Array.from(palette.querySelectorAll('img'));
        const thumbImg = images.find(i => i.src === data.thumb);
        if (thumbImg) thumbImg.remove();
      }

      movingHelm = null;
    });

    function exportJSON() {
      document.getElementById('exportArea').textContent = JSON.stringify(placedHelms, null, 2);
    }

    function copyJSON() {
      const text = document.getElementById('exportArea').textContent;
      navigator.clipboard.writeText(text).then(() => alert("JSON copied to clipboard."));
    }

    window.addEventListener('DOMContentLoaded', () => {
      fetch('data/helms.json')
        .then(res => {
          console.log('helms.json fetched');
          return res.json();
        })
        .then(helms => {
          console.log('helms loaded:', helms);
          helms.forEach(h => {
            const img = document.createElement('img');
            img.src = 'images/' + h.thumb;
            img.className = 'helm';
            img.title = h.name;
            img.dataset.name = h.name;
            img.dataset.image = h.image;
            img.dataset.col = h.col;
            img.dataset.row = h.row;
            img.dataset.thumbName = h.thumb;
            img.draggable = true;
            img.style.left = ((h.col - 1) * 202) + 'px';
            img.style.top = ((h.row - 1) * 205) + 'px';

            img.onclick = () => {
              if (confirm("Delete this helm?")) {
                document.getElementById('helmGrid').removeChild(img);
                const index = placedHelms.findIndex(p =>
                  p.col === h.col && p.row === h.row && p.name === h.name
                );
                if (index !== -1) placedHelms.splice(index, 1);
              }
            };

            document.getElementById('helmGrid').appendChild(img);
            placedHelms.push(h);
          });
        });
    });

    document.getElementById('uploadThumb').addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      const url = URL.createObjectURL(file);
      const filename = file.name;
      const name = filename.replace(/\.[^/.]+$/, "").replace(" - thumb", "");
      const image = filename.replace(" - thumb", "");

      const img = document.createElement('img');
      img.src = url;
      img.title = name;
      img.dataset.name = name;
      img.dataset.image = image;
      img.dataset.thumbName = filename;
      img.draggable = true;
      img.className = 'helm';
      palette.appendChild(img);
    });
  </script>
</body>
</html>
